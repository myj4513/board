<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="study.board.mapper.CommentMapper">
    <insert id="add" parameterType="Comment">
        insert into comment(article_id, content, user_id) values(#{articleId}, #{content}, #{userId})
    </insert>

    <select id="findAllByArticleId" parameterType="int" resultType="CommentView">
        select a.id, username, a.content, a.regdate, ifnull(likes,0) likes, ifnull(dislikes,0) dislikes from comment as a
            left join(
                select comment_id, count(likes) as likes
                from comment_likes
                where likes=1
                group by comment_id
                ) as b on a.id=b.comment_id
            left join(
                select comment_id, count(dislikes) as dislikes
                from comment_likes
                where dislikes=1
                group by comment_id
                ) as c on a.id=c.comment_id
            left join(
                select id, name as username
                from user
                ) as d on a.user_id=d.id where article_id=#{articleId}
    </select>

    <select id="countComments" parameterType="int" resultType="int">
        select count(*) from comment where article_id=#{articleId}
    </select>
</mapper>